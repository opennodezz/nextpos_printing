---
# Bitbucket pipeline: publish ONLY the nextpos_printing app folder
# to GitHub as a clean Frappe app repo.
# Ensures GitHub root = app root (setup.py, MANIFEST.in, etc.)

image: atlassian/default-image:latest   # Use Atlassianâ€™s default CI image

pipelines:
  branches:
    main:   # Trigger when pushing to Bitbucket "main" branch
      - step:
          name: Publish App Folder to GitHub
          script:
            # 1. Configure Git identity (needed for commits in CI)
            - git config --global user.email "ci-bot@yourdomain.com"
            - git config --global user.name "Bitbucket CI Bot"

            # 2. Create a clean working directory for publishing
            - mkdir publish

            # 3. Copy ONLY the app folder contents (no pipelines/docs/etc.)
            - cp -r nextpos_printing/* publish/

            # (Optional) Debug step: list copied files
            - ls -R publish

            # 4. Initialize a fresh git repo with the copied files
            - cd publish
            - git init
            - git checkout -b main   # Create a main branch

            # 5. Add GitHub as a remote using a Personal Access Token (PAT)
            # Token must be saved in Bitbucket Repo Variables as:
            #   NEXTPOS_PRINTING_PA_TOKEN_GITHUB
            - >
              git remote add github
              https://x-access-token:${NEXTPOS_PRINTING_PA_TOKEN_GITHUB}@github.com/opennodezz/nextpos_printing.git

            # 6. Stage all files
            - git add .

            # 7. Commit changes (skip error if nothing new)
            - >
              git commit -m "CI: publish app from Bitbucket $(date)" \
              || echo "No changes to commit"

            # 8. Push to GitHub, force-replacing branch each time
            - git push github main --force